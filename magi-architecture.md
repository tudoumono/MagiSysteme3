# MAGI System 全体構成

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────┐
│                           ユーザー                                   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     フロントエンド（Claude担当）                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    Streamlit                                  │  │
│  │  • チャットUI                                                  │  │
│  │  • 3カラム表示（MELCHIOR / BALTHASAR / CASPER）                 │  │
│  │  • 最終判定表示                                                │  │
│  │  • ストリーミング対応                                           │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                         Lightsail Container                         │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ invoke_agent_runtime()
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   バックエンド（Tudo担当）                            │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                 AgentCore Runtime                             │  │
│  │                                                               │  │
│  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │  │
│  │   │  MELCHIOR   │ │  BALTHASAR  │ │   CASPER    │            │  │
│  │   │  (科学者)    │ │  (母親)     │ │  (女性)     │            │  │
│  │   │  Strands    │ │  Strands    │ │  Strands    │            │  │
│  │   └──────┬──────┘ └──────┬──────┘ └──────┬──────┘            │  │
│  │          │               │               │                    │  │
│  │          └───────────────┼───────────────┘                    │  │
│  │                          ▼                                    │  │
│  │                   ┌─────────────┐                             │  │
│  │                   │    JUDGE    │                             │  │
│  │                   │  (統合判定)  │                             │  │
│  │                   └─────────────┘                             │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                        ECR + CodeBuild                              │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Amazon Bedrock                               │
│                   Claude Sonnet 4 (us-east-1)                       │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        CloudWatch                                   │
│                  AgentCore Observability                            │
│              （トレース・メトリクス・評価）                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント説明

| レイヤー | 技術 | 担当 | 役割 |
|---------|------|------|------|
| **フロント** | Streamlit + Lightsail | Claude | UI、ユーザー入力、結果表示 |
| **バックエンド** | Strands + AgentCore Runtime | Tudo | MAGIエージェント実行 |
| **AI基盤** | Amazon Bedrock | AWS | Claude呼び出し |
| **監視** | CloudWatch | AWS | トレース、評価 |

---

## データフロー

```
1. ユーザーが質問を入力
      ↓
2. Streamlit → AgentCore Runtime を呼び出し
      ↓
3. backend.py が受け取る
      ↓
4. MELCHIOR / BALTHASAR / CASPER が並列（または順次）で分析
      ↓
5. JUDGE が3つの結果を統合して最終判定
      ↓
6. ストリーミングで結果を返却
      ↓
7. Streamlit がリアルタイム表示
```

---

## ファイル構成

```
magi-system/
│
├── agentcore/                 # ← Tudo が作る
│   ├── backend.py             # メインのエージェントロジック
│   └── requirements.txt       # 依存パッケージ
│
└── frontend/                  # ← Claude が作る
    ├── frontend.py            # Streamlit UI
    ├── requirements.txt
    └── Dockerfile
```

---

## バックエンド (backend.py) の責務

```python
# 実装するもの

1. MAGIエージェントの定義
   - MELCHIOR: 科学的・論理的観点
   - BALTHASAR: 母性的・保護的観点
   - CASPER: 人間的・感情的観点

2. エントリーポイント
   - フロントからの問いかけを受け取る
   - 3エージェントを実行
   - 結果を統合して最終判定
   - ストリーミングで返却

3. AgentCore Runtime 対応
   - BedrockAgentCoreApp でラップ
   - デプロイ可能な形式に
```

---

## 使用する主要ライブラリ

| ライブラリ | 用途 |
|-----------|------|
| `strands-agents` | エージェント作成 |
| `bedrock-agentcore` | AgentCore Runtime対応 |
| `boto3` | AWS SDK |

---

## デプロイの流れ

```
1. ローカルで backend.py を作成・テスト
      ↓
2. agentcore configure で設定生成
      ↓
3. agentcore launch でデプロイ
      ↓
4. Runtime ARN を取得
      ↓
5. フロントエンドに ARN を設定
      ↓
6. 完成！
```

---

## 参考リンク

- [Strands Agents SDK](https://strandsagents.com/)
- [Amazon Bedrock AgentCore](https://docs.aws.amazon.com/bedrock-agentcore/)
- [minorun365 ハンズオン記事](https://qiita.com/minorun365/items/f3a43fd248d267e0efbc)
